@page "/blog/{ArticleName}"
@using Markdig
@using PortafolioBlog.Models
@using PortafolioBlog.Services
@inject HttpClient Http
@inject IJSRuntime JSRuntime

<PageTitle>@(postMetadata?.Titulo ?? "Cargando artículo...") - Wilmer</PageTitle>

<div class="container mt-5">
    <h1 id="titulo-principal" class="display-4 fw-bold text-primary mb-3 text-center">
        Blog: ¿Sueñan los ciegos con un mundo accesible?
    </h1>

    @if (articleHtml == null && componente == null)
    {
        <div class="d-flex align-items-center" role="status">
            <strong>Cargando contenido...</strong>
            <div class="spinner-border ms-auto" aria-hidden="true"></div>
        </div>
    }
    else
    {
        <article class="blog-content mt-4">
            @if (postMetadata != null && postMetadata.EsComponente && componente != null)
            {
                <DynamicComponent Type="@componente" />
            }
            else if (articleHtml != null)
            {
                @((MarkupString)articleHtml)
            }
        </article>

        <nav class="d-flex justify-content-between align-items-center my-5" aria-label="Navegación entre artículos">
            <div style="flex: 1;">
                @if (prevPost != null)
                {
                    <a href="blog/@prevPost.Id" class="btn btn-outline-primary w-100 text-start shadow-sm">
                        <span class="d-inline-block text-truncate" style="max-width: 100%;">@prevPost.Titulo</span>
                    </a>
                }
            </div>

            <div class="text-center" style="flex: 0.5;">
                <a href="blog" class="btn btn-link text-decoration-none" aria-label="Volver al índice del blog">
                    <span class="oi oi-grid-three-up" aria-hidden="true" style="font-size: 1.5rem;"></span>
                    <small class="d-block text-dark">Índice</small>
                </a>
            </div>

            <div class="text-end" style="flex: 1;">
                @if (nextPost != null)
                {
                    <a href="blog/@nextPost.Id" class="btn btn-outline-primary w-100 text-end shadow-sm">
                        <span class="d-inline-block text-truncate" style="max-width: 100%;">@nextPost.Titulo</span>
                    </a>
                }
            </div>
        </nav>
    }
</div>

<aside class="mt-5 py-5 border-top border-bottom text-center rounded shadow-sm bg-dark text-light" aria-labelledby="contacto-titulo">
    <h2 id="contacto-titulo" class="h4 mb-4 fw-bold">Contacto y Redes sociales</h2>
    <div class="d-flex flex-wrap justify-content-center gap-3 px-3">
        <a class="btn btn-primary" href="mailto:wilmer8981@hotmail.com">wilmer8981@hotmail.com</a>
        <a class="btn btn-outline-primary text-light" href="https://www.linkedin.com/in/wilmer-rodriguez-a98b5956/" target="_blank" rel="noopener">LinkedIn</a>
        <a class="btn btn-outline-primary text-light" href="https://clubdeescritura.com/perfil/171865/wilmer-rodriguez-vega" target="_blank" rel="noopener">Club de escritura</a>
        <a class="btn btn-outline-primary text-light" href="https://mastodon.cr/@@Wilmer" target="_blank" rel="noopener">Mastodon</a>
        <a class="btn btn-outline-primary text-light" href="https://www.threads.com/@@rvwilmer" target="_blank" rel="noopener">Threads</a>
        <a class="btn btn-outline-primary text-light" href="https://www.instagram.com/rvwilmer" target="_blank" rel="noopener">Instagram</a>
        <a class="btn btn-outline-primary text-light" href="https://www.facebook.com/wilmer.rv" target="_blank" rel="noopener">Facebook</a>
        <a class="btn btn-outline-primary text-light" href="https://linktr.ee/Wilmer.Rv.1989?utm_source=threads&utm_medium=social&utm_content=link_in_bio" target="_blank" rel="noopener">Linktree</a>
    </div>
</aside>

@code {
    [Parameter] public string? ArticleName { get; set; }
    private bool foco = false;
    private string? articleHtml;
    private PostMetadata? postMetadata;
    private PostMetadata? prevPost;
    private PostMetadata? nextPost;
    private Type? componente;

    protected override async Task OnParametersSetAsync()
    {
        foco = true;
        componente = null;
        articleHtml = null;
        postMetadata = null;
        prevPost = null;
        nextPost = null;

        if (!string.IsNullOrEmpty(ArticleName))
        {
            try
            {
                var articulos = await Http.GetFromJsonAsync<List<PostMetadata>>("data/posts.json");

                if (articulos != null)
                {
                    var hoy = DateTime.Now;
                    var listaPublicada = articulos
                        .Where(p => p.Fecha <= hoy)
                        .OrderByDescending(p => p.Fecha)
                        .ToList();

                    var currentIndex = listaPublicada.FindIndex(p => p.Id == ArticleName);

                    if (currentIndex != -1)
                    {
                        postMetadata = listaPublicada[currentIndex];

                        nextPost = currentIndex > 0 ? listaPublicada[currentIndex - 1] : null;
                        prevPost = currentIndex < listaPublicada.Count - 1 ? listaPublicada[currentIndex + 1] : null;

                        if (postMetadata.EsComponente)
                        {
                            componente = BlogComponentMapper.GetTypeById(ArticleName);
                        }
                        else
                        {
                            var markdown = await Http.GetStringAsync($"articles/{ArticleName}.md");
                            var pipeline = new MarkdownPipelineBuilder().UseAdvancedExtensions().Build();
                            articleHtml = Markdown.ToHtml(markdown, pipeline);
                        }
                    }
                    else
                    {
                        //manejar navegación incorrecta
                        articleHtml = "<div class='alert alert-warning text-center mt-5'>" +
                                      "<h3>Contenido no disponible</h3>" +
                                      "</div>";
                    }
                }
            }
            catch (Exception)
            {
                articleHtml = "<p class='alert alert-danger'>Error: No se pudo encontrar el artículo solicitado.</p>";
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // El foco y los scripts se disparan si hay algo cargado (HTML de MD o Componente Razor)
        if (articleHtml != null || componente != null)
        {
            // Ejecutamos el script de copiado para cualquier etiqueta <pre> presente en el DOM
            await JSRuntime.InvokeVoidAsync("clipboardFunctions.addCopyButtons");

            if (foco)
            {
                // Devolvemos el foco al título para una navegación fluida con NVDA
                await JSRuntime.InvokeVoidAsync("accessibilityFunctions.focusElement", "titulo-principal");
                foco = false;
            }
        }
    }
}