@page "/blog/{ArticleName}"
@using Markdig
@using PortafolioBlog.Models
@inject HttpClient Http
@inject IJSRuntime JSRuntime

<PageTitle>@(postMetadata?.Titulo ?? "Cargando artículo...") - Wilmer</PageTitle>

<div class="container mt-5">
    <h1 class="display-4 fw-bold text-primary mb-3 text-center">
        Blog: ¿Sueñan los ciegos con un mundo accesible?
    </h1>

    @if (articleHtml == null)
    {
        <div class="d-flex align-items-center" role="status">
            <strong>Cargando contenido...</strong>
            <div class="spinner-border ms-auto" aria-hidden="true"></div>
        </div>
    }
    else
    {
        <article class="blog-content mt-4">
            @((MarkupString)articleHtml)
        </article>
    }
</div>

<aside class="mt-5 py-5 border-top border-bottom text-center rounded shadow-sm bg-dark text-light" aria-labelledby="contacto-titulo">
    <h2 id="contacto-titulo" class="h4 mb-4 fw-bold">Contacto y Redes sociales</h2>
    <div class="d-flex flex-wrap justify-content-center gap-3 px-3">
        <a class="btn btn-primary" href="mailto:wilmer8981@hotmail.com">wilmer8981@hotmail.com|</a>
        <a class="btn btn-outline-primary" href="https://www.linkedin.com/in/wilmer-rodriguez-a98b5956/" target="_blank" rel="noopener">LinkedIn</a>
        <a class="btn btn-outline-primary" href="https://clubdeescritura.com/perfil/171865/wilmer-rodriguez-vega" target="_blank" rel="noopener">Club de escritura</a>
        <a class="btn btn-outline-primary" href="https://mastodon.cr/@@Wilmer" target="_blank" rel="noopener">Mastodon</a>
        <a class="btn btn-outline-primary" href="https://www.threads.com/@@rvwilmer" target="_blank" rel="noopener">Threads</a>
        <a class="btn btn-outline-primary" href="https://www.instagram.com/rvwilmer" target="_blank" rel="noopener">Instagram</a>
        <a class="btn btn-outline-primary" href="https://www.facebook.com/wilmer.rv" target="_blank" rel="noopener">Facebook</a>
        <a class="btn btn-outline-primary" href="https://linktr.ee/Wilmer.Rv.1989?utm_source=threads&utm_medium=social&utm_content=link_in_bio" target="_blank" rel="noopener">Linktree</a>
    </div>
</aside>

@code {
    [Parameter]
    public string? ArticleName { get; set; }

    private string? articleHtml;
    private PostMetadata? postMetadata;

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrEmpty(ArticleName))
        {
            try
            {
                // 1. Cargamos el índice de metadatos para obtener el título y otros datos
                var articulos = await Http.GetFromJsonAsync<List<PostMetadata>>("data/posts.json");
                postMetadata = articulos?.FirstOrDefault(p => p.Id == ArticleName);

                // 2. Buscamos el archivo .md
                var markdown = await Http.GetStringAsync($"articles/{ArticleName}.md");

                // 3. Configuramos Markdig
                var pipeline = new MarkdownPipelineBuilder().UseAdvancedExtensions().Build();

                // 4. Convertimos a HTML
                articleHtml = Markdown.ToHtml(markdown, pipeline);
            }
            catch (Exception)
            {
                articleHtml = "<p class='alert alert-danger'>Error: No se pudo encontrar el artículo solicitado.</p>";
            }
        }
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Solo ejecutamos el script si ya tenemos el HTML cargado en pantalla
        if (articleHtml != null)
        {
            await JSRuntime.InvokeVoidAsync("clipboardFunctions.addCopyButtons");
        }
    }
}
